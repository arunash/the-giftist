generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                            String          @id @default(cuid())
  email                         String?         @unique
  phone                         String?         @unique
  name                          String?
  image                         String?
  emailVerified                 DateTime?
  createdAt                     DateTime        @default(now())
  updatedAt                     DateTime        @updatedAt
  pendingProduct                String?
  birthday                      DateTime?
  gender                        String?
  ageRange                      String?
  interests                     String?
  giftBudget                    String?
  relationship                  String?
  shareId                       String?         @unique @default(cuid())
  linkingToken                  String?
  lifetimeContributionsReceived Float           @default(0)
  stripeConnectAccountId        String?         @unique
  stripeConnectOnboarded        Boolean         @default(false)
  lastDigestSentAt              DateTime?
  digestOptOut                  Boolean         @default(false)
  followUpSentAt                DateTime?
  followUpStage                 Int             @default(0)
  timezone                      String?
  preferredPayoutMethod         String?
  venmoHandle                   String?
  paypalEmail                   String?
  payoutSetupComplete           Boolean         @default(false)
  isActive                      Boolean         @default(true)
  suspendedAt                   DateTime?
  suspendedReason               String?
  accounts                      Account[]
  activityEvents                ActivityEvent[]
  chatMessages                  ChatMessage[]
  circleMembers                 CircleMember[]
  contributions                 Contribution[]
  events                        Event[]
  giftLists                     GiftList[]
  giftListItems                 GiftListItem[]
  items                         Item[]
  sessions                      Session[]
  subscription                  Subscription?
  wallet                        Wallet?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Item {
  id                 String              @id @default(cuid())
  userId             String
  name               String
  price              String?
  priceValue         Float?
  image              String?
  url                String
  domain             String
  category           String?
  addedAt            DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  source             String              @default("MANUAL")
  notes              String?
  tags               String?
  goalAmount         Float?
  fundedAmount       Float               @default(0)
  isPurchased        Boolean             @default(false)
  purchasedAt        DateTime?
  activityEvents     ActivityEvent[]
  contributions      Contribution[]
  eventItems         EventItem[]
  giftListItems      GiftListItem[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  priceHistory       PriceHistory[]
  walletTransactions WalletTransaction[]

  @@index([userId])
}

model PriceHistory {
  id         String   @id @default(cuid())
  itemId     String
  price      Float
  recordedAt DateTime @default(now())
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model Event {
  id               String         @id @default(cuid())
  userId           String
  name             String
  type             String
  date             DateTime
  description      String?
  shareUrl         String?        @unique @default(cuid())
  isPublic         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  fundedAmount     Float          @default(0)
  circleNotifiedAt DateTime?
  contributions    Contribution[]
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items            EventItem[]
  giftLists        GiftList[]

  @@index([userId])
}

model EventItem {
  id       String   @id @default(cuid())
  eventId  String
  itemId   String
  priority Int      @default(0)
  addedAt  DateTime @default(now())
  event    Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([eventId, itemId])
}

model Contribution {
  id                String    @id @default(cuid())
  itemId            String?
  eventId           String?
  contributorId     String?
  contributorEmail  String?
  amount            Float
  message           String?
  isAnonymous       Boolean   @default(false)
  stripePaymentId   String?
  paymentProvider   String    @default("STRIPE")
  status            String    @default("PENDING")
  platformFeeRate   Float     @default(0)
  platformFeeAmount Float     @default(0)
  thankYouMessage   String?
  thankYouSentAt    DateTime?
  createdAt         DateTime  @default(now())
  contributor       User?     @relation(fields: [contributorId], references: [id])
  event             Event?    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  item              Item?     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([eventId])
}

model GiftList {
  id          String         @id @default(cuid())
  userId      String
  name        String
  description String?
  shareUrl    String         @unique @default(cuid())
  isPublic    Boolean        @default(true)
  eventId     String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  event       Event?         @relation(fields: [eventId], references: [id])
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       GiftListItem[]

  @@index([userId])
}

model GiftListItem {
  id        String   @id @default(cuid())
  listId    String
  itemId    String
  priority  Int      @default(0)
  addedById String?
  note      String?
  addedAt   DateTime @default(now())
  addedBy   User?    @relation(fields: [addedById], references: [id])
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  list      GiftList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, itemId])
  @@index([listId])
}

model WhatsAppMessage {
  id          String    @id @default(cuid())
  waMessageId String    @unique
  phone       String
  type        String
  content     String?
  itemId      String?
  status      String    @default("RECEIVED")
  error       String?
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([phone])
}

model Wallet {
  id           String              @id @default(cuid())
  userId       String              @unique
  balance      Float               @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
}

model WalletTransaction {
  id              String   @id @default(cuid())
  walletId        String
  type            String
  amount          Float
  stripeSessionId String?
  itemId          String?
  status          String   @default("PENDING")
  description     String?
  createdAt       DateTime @default(now())
  item            Item?    @relation(fields: [itemId], references: [id])
  wallet          Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
}

model ActivityEvent {
  id         String   @id @default(cuid())
  userId     String
  type       String
  visibility String   @default("PRIVATE")
  metadata   String?
  itemId     String?
  createdAt  DateTime @default(now())
  item       Item?    @relation(fields: [itemId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String
  content   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  status               String    @default("INACTIVE")
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ApiCallLog {
  id            String   @id @default(cuid())
  provider      String
  endpoint      String
  model         String?
  inputTokens   Int?
  outputTokens  Int?
  estimatedCost Float    @default(0)
  userId        String?
  source        String?
  metadata      String?
  createdAt     DateTime @default(now())

  @@index([provider])
  @@index([createdAt])
}

model ErrorLog {
  id        String   @id @default(cuid())
  source    String
  message   String
  stack     String?
  metadata  String?
  severity  String   @default("ERROR")
  createdAt DateTime @default(now())

  @@index([source])
  @@index([createdAt])
}

model CircleMember {
  id           String   @id @default(cuid())
  userId       String
  phone        String
  name         String?
  relationship String?
  source       String   @default("MANUAL")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, phone])
  @@index([userId])
}
