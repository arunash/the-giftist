generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  phone         String?   @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Pending product confirmation (WhatsApp flow)
  pendingProduct String? // JSON: {name, price, priceValue, image, url, domain, source}

  // Demographics (for AI personalization)
  birthday     DateTime?
  gender       String?   // MALE, FEMALE, NON_BINARY, PREFER_NOT_TO_SAY
  ageRange     String?   // 18-24, 25-34, 35-44, 45-54, 55-64, 65+
  interests    String?   // JSON array: ["tech","fashion",...]
  giftBudget   String?   // UNDER_50, 50_100, 100_250, 250_500, OVER_500
  relationship String?   // SINGLE, COUPLE, FAMILY

  // Relations
  accounts       Account[]
  sessions       Session[]
  items          Item[]
  events         Event[]
  contributions  Contribution[]
  giftLists      GiftList[]
  giftListItems  GiftListItem[]
  wallet         Wallet?
  subscription   Subscription?
  activityEvents ActivityEvent[]
  chatMessages   ChatMessage[]
  shareId        String?   @unique @default(cuid())

  // Account linking
  linkingToken String?

  // Monetization
  lifetimeContributionsReceived Float   @default(0)
  stripeConnectAccountId        String? @unique
  stripeConnectOnboarded        Boolean @default(false)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Item {
  id           String   @id @default(cuid())
  userId       String
  name         String
  price        String?
  priceValue   Float?
  image        String?
  url          String
  domain       String
  category     String?
  addedAt      DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Price tracking
  priceHistory PriceHistory[]

  // Source tracking
  source       String   @default("MANUAL") // WHATSAPP, EXTENSION, MANUAL, CHAT
  notes        String?
  tags         String?  // JSON array string

  // Wallet/funding
  goalAmount   Float?
  fundedAmount Float    @default(0)
  isPurchased  Boolean  @default(false)
  purchasedAt  DateTime?

  // Relations
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventItems         EventItem[]
  contributions      Contribution[]
  giftListItems      GiftListItem[]
  walletTransactions WalletTransaction[]
  activityEvents     ActivityEvent[]

  @@index([userId])
}

model PriceHistory {
  id        String   @id @default(cuid())
  itemId    String
  price     Float
  recordedAt DateTime @default(now())

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model Event {
  id          String    @id @default(cuid())
  userId      String
  name        String
  type        String    // BIRTHDAY, ANNIVERSARY, WEDDING, BABY_SHOWER, CHRISTMAS, HOLIDAY, OTHER
  date        DateTime
  description String?
  shareUrl    String?   @unique @default(cuid())
  isPublic    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     EventItem[]
  giftLists GiftList[]

  @@index([userId])
}

model EventItem {
  id        String   @id @default(cuid())
  eventId   String
  itemId    String
  priority  Int      @default(0)
  addedAt   DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  item  Item  @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([eventId, itemId])
}

model Contribution {
  id            String   @id @default(cuid())
  itemId        String
  contributorId String?  // null if anonymous
  amount        Float
  message       String?
  isAnonymous   Boolean  @default(false)
  stripePaymentId String?
  status        String   @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED
  platformFeeRate   Float @default(0)
  platformFeeAmount Float @default(0)
  createdAt     DateTime @default(now())

  item        Item  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  contributor User? @relation(fields: [contributorId], references: [id])

  @@index([itemId])
}

model GiftList {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  shareUrl    String   @unique @default(cuid())
  isPublic    Boolean  @default(true)
  eventId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event?         @relation(fields: [eventId], references: [id], onDelete: SetNull)
  items GiftListItem[]

  @@index([userId])
}

model GiftListItem {
  id       String  @id @default(cuid())
  listId   String
  itemId   String
  priority Int     @default(0)
  addedById String?
  note     String?
  addedAt  DateTime @default(now())

  // Relations
  list    GiftList @relation(fields: [listId], references: [id], onDelete: Cascade)
  item    Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  addedBy User?    @relation(fields: [addedById], references: [id])

  @@unique([listId, itemId])
  @@index([listId])
}

model WhatsAppMessage {
  id          String    @id @default(cuid())
  waMessageId String    @unique
  phone       String
  type        String
  content     String?
  itemId      String?
  status      String    @default("RECEIVED")
  error       String?
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([phone])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
}

model WalletTransaction {
  id              String   @id @default(cuid())
  walletId        String
  type            String   // DEPOSIT, FUND_ITEM, REFUND, PAYOUT
  amount          Float
  stripeSessionId String?
  itemId          String?
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  description     String?
  createdAt       DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  item   Item?  @relation(fields: [itemId], references: [id])

  @@index([walletId])
}

model ActivityEvent {
  id         String   @id @default(cuid())
  userId     String
  type       String   // ITEM_ADDED, ITEM_FUNDED, ITEM_PURCHASED, WALLET_DEPOSIT, CONTRIBUTION_RECEIVED, EVENT_CREATED
  visibility String   @default("PRIVATE") // PRIVATE, PUBLIC
  metadata   String?  // JSON string
  itemId     String?
  createdAt  DateTime @default(now())

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item? @relation(fields: [itemId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String   // USER, ASSISTANT
  content   String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  status               String    @default("INACTIVE") // ACTIVE, INACTIVE, PAST_DUE, CANCELED
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ApiCallLog {
  id            String   @id @default(cuid())
  provider      String   // ANTHROPIC, OPENAI, TWILIO, STRIPE, WHATSAPP
  endpoint      String
  model         String?
  inputTokens   Int?
  outputTokens  Int?
  estimatedCost Float    @default(0)
  userId        String?
  source        String?  // WEB, WHATSAPP, WEBHOOK
  metadata      String?
  createdAt     DateTime @default(now())

  @@index([provider])
  @@index([createdAt])
}

model ErrorLog {
  id        String   @id @default(cuid())
  source    String   // STRIPE_WEBHOOK, WHATSAPP_WEBHOOK, API, CHAT, EXTRACT
  message   String
  stack     String?
  metadata  String?
  severity  String   @default("ERROR")
  createdAt DateTime @default(now())

  @@index([source])
  @@index([createdAt])
}
